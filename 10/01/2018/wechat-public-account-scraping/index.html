<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Wechat Subscription Account Scraping | Jeremy Haouan Zhang</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Wechat Subscription Account Scraping</h1><a id="logo" href="/.">Jeremy Haouan Zhang</a><p class="description">Action is the foundational key to all success.</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Wechat Subscription Account Scraping</h1><div class="post-meta">Jan 10, 2018</div><div class="post-content"><p> Wechat is a most popular social application in China. The data from subscription accounts based on Wechat is very valuable for the accounts runner and advertisement owner. The data we will scrap including attributes: Artical_Title, Artical_Content, Artical_Views, Artical Times. At the end, I will store them into MangoDB. The language I uesed are Python and Node.js.<br> Note: there are two parts: 1. Python for scrap the url and title of the artical 2. Node.js for artical views</p>
<h1 id="Python-Part"><a href="#Python-Part" class="headerlink" title="Python Part"></a>Python Part</h1><p>##Prepare</p>
<p>First you need to have a wechat public account which could apply on Wechat website. I  use MacOS system and Python 3.6.3. Use Pip to install request, json,time,csv, Webdriver with google</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Use selenium to control Chrome to simulate browser action</span></span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">import redis</span><br><span class="line">import json</span><br><span class="line">import re</span><br><span class="line">import random</span><br><span class="line">import time</span><br><span class="line">from selenium import webdriver</span><br><span class="line">import time</span><br><span class="line">import csv</span><br></pre></td></tr></table></figure>
<p>Open the webdrive</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">post = &#123;&#125;</span><br><span class="line">driver = webdriver.Chrome(executable_path=<span class="string">'/yourpath/chromedriver'</span>)</span><br><span class="line">driver.get(<span class="string">'https://mp.weixin.qq.com/'</span>)</span><br><span class="line">time.sleep(2)</span><br></pre></td></tr></table></figure>
<p>Find element and fill the blank<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">driver.find_element_by_xpath(<span class="string">"./*//input[@name='account']"</span>).clear()</span><br><span class="line">driver.find_element_by_xpath(<span class="string">"./*//input[@name='account']"</span>).send_keys(<span class="string">'########'</span>)   <span class="comment">##your username</span></span><br><span class="line"><span class="comment">#send keys value should be the id of your wechat id</span></span><br><span class="line">driver.find_element_by_xpath(<span class="string">"./*//input[@name='password']"</span>).clear()</span><br><span class="line">driver.find_element_by_xpath(<span class="string">"./*//input[@name='password']"</span>).send_keys(<span class="string">'#######'</span>)   <span class="comment">##your password</span></span><br><span class="line"><span class="comment">#send keys value should be your password</span></span><br><span class="line"><span class="comment"># Click remember me</span></span><br><span class="line">time.sleep(5)</span><br></pre></td></tr></table></figure></p>
<p>Find ‘Login’ button and click<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">driver.find_element_by_xpath(&quot;./*//a[@title=&apos;点击登录&apos;]&quot;).click()</span><br></pre></td></tr></table></figure></p>
<p>Since the QR code is automatically generate, we need to scan it after it appears by your wechat app on the phone<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># scan the code</span><br><span class="line">time.sleep(20)</span><br></pre></td></tr></table></figure></p>
<p>Save Cookie<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">driver.get(<span class="string">'https://mp.weixin.qq.com/'</span>)</span><br><span class="line">cookie_items = driver.get_cookies()</span><br><span class="line"><span class="keyword">for</span> cookie_item <span class="keyword">in</span> cookie_items:</span><br><span class="line">    post[cookie_item[<span class="string">'name'</span>]] = cookie_item[<span class="string">'value'</span>]</span><br><span class="line">cookie_str = json.dumps(post)</span><br><span class="line">with open(<span class="string">'cookie.txt'</span>, <span class="string">'w+'</span>, encoding=<span class="string">'utf-8'</span>) as f:</span><br><span class="line">    f.write(cookie_str)</span><br></pre></td></tr></table></figure></p>
<p>add header<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gzlist = [&apos;yq_Butler&apos;]</span><br><span class="line"></span><br><span class="line">url = &apos;https://mp.weixin.qq.com&apos;</span><br><span class="line">header = header = &#123;</span><br><span class="line">    &quot;HOST&quot;: &quot;mp.weixin.qq.com&quot;,</span><br><span class="line">    &quot;User_Agent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Open the cookie and get the url<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">with open(<span class="string">'cookie.txt'</span>, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) as f:</span><br><span class="line">    cookie = f.read()</span><br><span class="line">cookies = json.loads(cookie)</span><br><span class="line">response = requests.get(url=url, cookies=cookies)</span><br><span class="line">token = re.findall(r<span class="string">'token=(\d+)'</span>, str(response.url))[0]</span><br><span class="line"><span class="keyword">for</span> query <span class="keyword">in</span> gzlist:</span><br><span class="line">    query_id = &#123;</span><br><span class="line">        <span class="string">'action'</span>: <span class="string">'search_biz'</span>,</span><br><span class="line">        <span class="string">'token'</span> : token,</span><br><span class="line">        <span class="string">'lang'</span>: <span class="string">'zh_CN'</span>,</span><br><span class="line">        <span class="string">'f'</span>: <span class="string">'json'</span>,</span><br><span class="line">        <span class="string">'ajax'</span>: <span class="string">'1'</span>,</span><br><span class="line">        <span class="string">'random'</span>: random.random(),</span><br><span class="line">        <span class="string">'query'</span>: <span class="string">'dianping_sydney'</span>,</span><br><span class="line">        <span class="comment"># 'kebeiquan' is a wechat id</span></span><br><span class="line">        <span class="string">'begin'</span>: <span class="string">'0'</span>,</span><br><span class="line">        <span class="string">'count'</span>: <span class="string">'5'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    search_url = <span class="string">'https://mp.weixin.qq.com/cgi-bin/searchbiz?'</span></span><br><span class="line">    search_response = requests.get(search_url, cookies=cookies, headers=header, params=query_id)</span><br><span class="line">    lists = search_response.json().get(<span class="string">'list'</span>)[0]</span><br><span class="line">    fakeid = lists.get(<span class="string">'fakeid'</span>)</span><br><span class="line">    query_id_data = &#123;</span><br><span class="line">        <span class="string">'token'</span>: token,</span><br><span class="line">        <span class="string">'lang'</span>: <span class="string">'zh_CN'</span>,</span><br><span class="line">        <span class="string">'f'</span>: <span class="string">'json'</span>,</span><br><span class="line">        <span class="string">'ajax'</span>: <span class="string">'1'</span>,</span><br><span class="line">        <span class="string">'random'</span>: random.random(),</span><br><span class="line">        <span class="string">'action'</span>: <span class="string">'list_ex'</span>,</span><br><span class="line">        <span class="string">'begin'</span>: <span class="string">'0'</span>,</span><br><span class="line">        <span class="string">'count'</span>: <span class="string">'5'</span>,</span><br><span class="line">        <span class="string">'query'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'fakeid'</span>: fakeid,</span><br><span class="line">        <span class="string">'type'</span>: <span class="string">'9'</span></span><br><span class="line">    &#125;</span><br><span class="line">    appmsg_url = <span class="string">'https://mp.weixin.qq.com/cgi-bin/appmsg?'</span></span><br><span class="line">    appmsg_response = requests.get(appmsg_url, cookies=cookies, headers=header, params=query_id_data)</span><br><span class="line">    max_num = appmsg_response.json().get(<span class="string">'app_msg_cnt'</span>)</span><br><span class="line">    num = int(int(max_num) / 5)</span><br><span class="line">    begin = 250</span><br><span class="line">    <span class="keyword">while</span> num + 1 &gt; 0 :</span><br><span class="line">        query_id_data = &#123;</span><br><span class="line">            <span class="string">'token'</span>: token,</span><br><span class="line">            <span class="string">'lang'</span>: <span class="string">'zh_CN'</span>,</span><br><span class="line">            <span class="string">'f'</span>: <span class="string">'json'</span>,</span><br><span class="line">            <span class="string">'ajax'</span>: <span class="string">'1'</span>,</span><br><span class="line">            <span class="string">'random'</span>: random.random(),</span><br><span class="line">            <span class="string">'action'</span>: <span class="string">'list_ex'</span>,</span><br><span class="line">            <span class="string">'begin'</span>: <span class="string">'&#123;&#125;'</span>.format(str(begin)),</span><br><span class="line">            <span class="string">'count'</span>: <span class="string">'5'</span>,</span><br><span class="line">            <span class="string">'query'</span>: <span class="string">''</span>,</span><br><span class="line">            <span class="string">'fakeid'</span>: fakeid,</span><br><span class="line">            <span class="string">'type'</span>: <span class="string">'9'</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'next page###################'</span>,begin)</span><br><span class="line">        query_fakeid_response = requests.get(appmsg_url, cookies=cookies, headers=header, params=query_id_data)</span><br><span class="line">        fakeid_list = query_fakeid_response.json().get(<span class="string">'app_msg_list'</span>)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> fakeid_list:</span><br><span class="line">            <span class="built_in">print</span>(item.get(<span class="string">'link'</span>))</span><br><span class="line">            url = [item.get(<span class="string">'link'</span>)]</span><br><span class="line">        num -= 1</span><br><span class="line">        begin = int(begin)</span><br><span class="line">        begin+=5</span><br><span class="line">        time.sleep(8)</span><br><span class="line"><span class="built_in">print</span> (url)</span><br></pre></td></tr></table></figure></p>
<p>Save URL to csv file</p>
<p>c = open(‘url1.csv’,’w’)<br>writer=csv.writer(c)<br>writer.writerow(url)</p>
<p><code>`</code></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://github.com/JeremyZhaler/haoxuan.github.io/10/01/2018/wechat-public-account-scraping/" data-id="cjjw8723700028zwlrsz2vef1" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAADJ0lEQVR42u3aS27jMBAFwNz/0p5tgInl99g0YNGllSHLIotZdPrz8xNfj1/Xszv/33/2TPLO5A2/f/XzjgsbGxv7JuxksXz561/lnyfviQ4OGxsb+zj2dWDYG4QewZWs1e4TGxsbGztJNta2lRxlG8ywsbGxsTf8u3/5tknK8UEBDBsbG/tj2POwlB/TJCy1a22opWFjY2N/PDvvin7+57f0t7GxsbE/mP0or7UCU9skbpvNtQIbGxv7IPa8ZD8pKl0XfdYSmHz/2NjY2Cexk2DQBqT8+Ry8K03CxsbG/gb23jC2lsashcDF92NjY2MfwU423ZZykoCU49dGdoqIjY2NjX1z9jvSgxbZwvIBnQiPjY2NfVv2WtEnTxgmga0NsUUJDBsbG/sI9hopDzzvOJr2EP/4jI2NjX00O28JJN/mgzV5s7ZNZrCxsbG/gb1WlGnvtIc1T0iePoONjY19EDvf0OQ42rSkfVvSii7yIWxsbOxbsXd1GK4PK2/95seUpC5Pd46NjY19EPsdRaLJt21qMUp4sLGxsY9gTwJSi2xbuWthNRoSxcbGxj6I3W60XbINY3nys1a0wsbGxj6bnS/TlpDWClV5IWltuAcbGxv7DHabhKylEG0w2xUyXxSVsLGxsQ9it4X4yUYnTYK10Pi0H4KNjY19BDt/9bx4lAfLyRjQdYqCjY2NfR67/ie+HJfJC0m7msHRnwcbGxv7OHY7ZJM83zZ088GgpJHw4rfY2NjYh7J3ba4djs9HiBJY9Aw2Njb2Qey21Tpp0+bPR5uej2BiY2NjH8duX9GW5ttEpU056uCHjY2NfRx70ljN7+wqUbVDPxvavdjY2Ng3ZOdBZUKapDqjAhY2Njb2EexHebXLTApM8zGgIpfCxsbGvi17VyGphbXHtNaQ3tBgwMbGxr4JOwlaa8lAe2TJ8eVH/2Kf2NjY2Mex86LMpMTftoTzN+yY4sHGxsb+LnayfN42mKQuebryRyqCjY2N/fXsfEwnXytZZZ4IYWNjY5/Hzgs3k7ZrXjbK2wxtkoONjY19HnutApMEkjYJyYeBJkkRNjY29kHsfwMxz6vG1IWbAAAAAElFTkSuQmCC">Share</a><div class="tags"><a href="/tags/Data-scraping/">Data scraping</a></div><div class="post-nav"><a class="pre" href="/17/07/2018/hello-world/">Hello World</a><a class="next" href="/17/07/2017/test/">hello world</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://github.com/JeremyZhaler/haoxuan.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Data-scraping/" style="font-size: 15px;">Data scraping</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/17/07/2018/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/10/01/2018/wechat-public-account-scraping/">Wechat Subscription Account Scraping</a></li><li class="post-list-item"><a class="post-list-link" href="/17/07/2017/test/">hello world</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://www.uts.edu.au/" title="University of technology Sydney" target="_blank">University of technology Sydney</a><ul></ul><a href="https://www.linkedin.com/in/haoxuanzhang/" title="Linkdin" target="_blank">Linkdin</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Jeremy Haouan Zhang.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" color="66, 179, 244" opacity="0.6" zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>